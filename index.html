<!DOCTYPE html>
<html>
<head>
    <title>Live Vehicle Tracker</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
        }

        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 6px;
            box-shadow: 0 0 5px rgba(0,0,0,0.3);
            font-family: Arial, sans-serif;
        }

        #controls label, #controls input, #controls select {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
        }

        #controls input, #controls select {
            width: 200px;
            padding: 4px;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        /* Smaller dots */
        .circle-marker div {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            border: 1px solid white;
        }
    </style>
</head>
<body>
    <div id="controls">
        <label for="vehicleSelect">Vehicle:</label>
        <select id="vehicleSelect">
            <option value="all">All Vehicles</option>
        </select>

        <label for="startDate">Start Date & Time:</label>
        <input type="datetime-local" id="startDate">

        <label for="endDate">End Date & Time:</label>
        <input type="datetime-local" id="endDate">
    </div>

    <div id="map"></div>

    <script>
        // Firebase setup
        firebase.initializeApp({ databaseURL: "https://iplant-poc-default-rtdb.firebaseio.com/" });
        const db = firebase.database();

        // Leaflet map setup
        const map = L.map('map').setView([-33.9, 18.4], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // DOM Elements
        const vehicleSelect = document.getElementById('vehicleSelect');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');

        // State containers
        const markers = {};
        const polylines = {};
        const vehicleColors = {};
        const colorPalette = [
            "#e6194b", "#3cb44b", "#ffe119", "#4363d8", "#f58231",
            "#911eb4", "#46f0f0", "#f032e6", "#bcf60c", "#fabebe",
            "#008080", "#e6beff", "#9a6324", "#fffac8", "#800000",
            "#aaffc3", "#808000", "#ffd8b1", "#000075", "#808080"
        ];
        let colorIndex = 0;

        function getVehicleColor(vid) {
            if (!vehicleColors[vid]) {
                vehicleColors[vid] = colorPalette[colorIndex % colorPalette.length];
                colorIndex++;
            }
            return vehicleColors[vid];
        }

        function clearMap() {
            Object.values(markers).forEach(m => map.removeLayer(m));
            Object.values(polylines).forEach(p => map.removeLayer(p));
            Object.keys(markers).forEach(k => delete markers[k]);
            Object.keys(polylines).forEach(k => delete polylines[k]);
        }

        function updateMap(data, selectedVehicle, startDate, endDate) {
            clearMap();

            // Rebuild dropdown
            vehicleSelect.innerHTML = '<option value="all">All Vehicles</option>';
            Object.keys(data).forEach(vid => {
                const option = document.createElement('option');
                option.value = vid;
                option.textContent = vid;
                if (vid === selectedVehicle) option.selected = true;
                vehicleSelect.appendChild(option);
            });

            const boundsArr = [];

            for (let vid in data) {
                if (selectedVehicle !== 'all' && vid !== selectedVehicle) continue;

                let points = Object.values(data[vid])
                    .sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                // Filter by date
                if (startDate && endDate) {
                    points = points.filter(p => {
                        const ts = new Date(p.timestamp);
                        return ts >= startDate && ts <= endDate;
                    });
                }

                if (!points.length) continue;

                const vehicleColor = getVehicleColor(vid);

                let segment = [];
                let lastTime = null;

                points.forEach((p, idx) => {
                    const latlng = [p.lat, p.lon];
                    const currentTime = new Date(p.timestamp);

                    // Break line if gap > 1 hour
                    if (lastTime && (currentTime - lastTime) > (60 * 60 * 1000)) {
                        if (segment.length > 1) {
                            const polyline = L.polyline(segment, { color: vehicleColor }).addTo(map);
                            polylines[vid + "_" + idx] = polyline;
                        }
                        segment = [];
                    }

                    segment.push(latlng);
                    lastTime = currentTime;

                    // Marker
// Marker
const markerIcon = (idx === points.length - 1)
    ? L.icon({
        iconUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34]
    })
    : L.divIcon({
        className: "circle-marker",
        html: `<div style="background:${vehicleColor}"></div>`
    });



                    const marker = L.marker(latlng, { icon: markerIcon }).addTo(map)
                        .bindPopup(`
                            <b>${vid}</b><br>
                            Status: ${p.status}<br>
                            Speed: ${p.speed ?? 'N/A'} km/h<br>
                            Time: ${currentTime.toLocaleString("en-GB", {
                                day: "2-digit", month: "short", year: "numeric",
                                hour: "2-digit", minute: "2-digit"
                            })}
                        `)
                        .bindTooltip(`${vid}`, { permanent: false, direction: 'top' });

                    markers[`${vid}_${idx}`] = marker;
                    boundsArr.push(latlng);
                });

                // Draw last segment
                if (segment.length > 1) {
                    const polyline = L.polyline(segment, { color: vehicleColor }).addTo(map);
                    polylines[vid + "_final"] = polyline;
                }
            }

            // Optional: Auto-fit map
            // if (boundsArr.length > 0) {
            //     const bounds = L.latLngBounds(boundsArr);
            //     map.fitBounds(bounds, { padding: [20, 20] });
            // }
        }

        function applyFilters() {
            const selected = vehicleSelect.value;
            const start = startDateInput.value ? new Date(startDateInput.value) : null;
            const end = endDateInput.value ? new Date(endDateInput.value) : null;

            db.ref('vehicles').once('value').then(snap => {
                const data = snap.val();
                if (data) updateMap(data, selected, start, end);
            });
        }

        // Initial load
        db.ref('vehicles').once('value').then(snap => {
            const data = snap.val();
            if (data) updateMap(data, 'all', null, null);
        });

        // Auto-filter on any change
        vehicleSelect.addEventListener('change', applyFilters);
        startDateInput.addEventListener('change', applyFilters);
        endDateInput.addEventListener('change', applyFilters);
    </script>
</body>
</html>
